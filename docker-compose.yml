version: "3.9"

services:
  fl-server:
    build: .
    container_name: fl-server
    command: ["python", "src/federated_learning/fl_server.py", "--address", "0.0.0.0:8080"]
    ports:
      - "8080:8080"       # IMPORTANT FIX
    environment:
      - SERVER_ADDRESS=0.0.0.0:8080
    volumes:
      - .:/app
    restart: unless-stopped

  fl-client-hospital-a:
    build: .
    container_name: fl-client-hospital-a
    depends_on:
      - fl-server
    command: ["python", "src/federated_learning/fl_client.py", "--node-name", "hospital_A"]
    environment:
      - SERVER_ADDRESS=fl-server:8080      # CRITICAL FIX
    volumes:
      - .:/app
    restart: unless-stopped

  fl-client-hospital-b:
    build: .
    container_name: fl-client-hospital-b
    depends_on:
      - fl-server
    command: ["python", "src/federated_learning/fl_client.py", "--node-name", "hospital_B"]
    environment:
      - SERVER_ADDRESS=fl-server:8080
    volumes:
      - .:/app
    restart: unless-stopped

  fl-client-hospital-c:
    build: .
    container_name: fl-client-hospital-c
    depends_on:
      - fl-server
    command: ["python", "src/federated_learning/fl_client.py", "--node-name", "hospital_C"]
    environment:
      - SERVER_ADDRESS=fl-server:8080
    volumes:
      - .:/app
    restart: unless-stopped
